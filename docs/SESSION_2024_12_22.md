# Development Session Documentation

> **Session Date**: December 22, 2024  
> **Focus Areas**: Value Resolution, Reactive UI, Static Visualization, Design System Consolidation

---

## Table of Contents

1. [Value Resolution Architecture](#value-resolution-architecture)
2. [Reactive UI System](#reactive-ui-system)
3. [Node Registration System](#node-registration-system)
4. [Static Oscillator Visualization](#static-oscillator-visualization)
5. [Design System Tokens](#design-system-tokens)
6. [Troubleshooting Guide](#troubleshooting-guide)
7. [Files Modified](#files-modified)

---

## Value Resolution Architecture

### 3-Level Property Hierarchy

The engine uses a strict 3-level hierarchy for resolving property values:

```
┌─────────────────────────────────────────────────────────────┐
│  LEVEL 3 (Highest Priority): Runtime Overrides              │
│  └─ Written by: processConnections() in AnimationEngine     │
│  └─ Source: Connection data from source node outputs        │
│  └─ Location: engineStore.runtime.overrides[nodeId][prop]   │
├─────────────────────────────────────────────────────────────┤
│  LEVEL 2: Presets (Future)                                   │
│  └─ Written by: User preset selection                        │
│  └─ Location: engineStore.project.presets                    │
├─────────────────────────────────────────────────────────────┤
│  LEVEL 1 (Base): User-Defined Props                          │
│  └─ Written by: SidePanel UI, node initialization            │
│  └─ Location: engineStore.project.nodes[nodeId].baseProps    │
└─────────────────────────────────────────────────────────────┘
```

### Key File: `src/core/resolveProperty.ts`

```typescript
export function resolveProperty(
  nodeId: string,
  propName: string,
  defaultVal: any
): any {
  // 1. Check Runtime Overrides (connections)
  const overrides = engineStore.runtime.overrides[nodeId];
  if (overrides && overrides[propName] !== undefined) {
    return overrides[propName];
  }

  // 2. Check Base Props (user values)
  const node = engineStore.project.nodes[nodeId];
  if (node?.baseProps[propName] !== undefined) {
    return node.baseProps[propName];
  }

  // 3. Fallback to default
  return defaultVal;
}
```

### Critical Protection: BaseProps Corruption Prevention

**Problem Solved**: When connections were active, `baseProps` was being overwritten with override values, preventing reversion when connections were disabled.

**Solution Layers**:

1. **AnimationEngine.ts** - Removed legacy `useEffect` that wrote connection values directly to `baseProps`
2. **store.ts** - `updateNodeProps()` filters out properties with active overrides
3. **SidePanel.tsx** - `handleChange()` ignores edits when override is active

---

## Reactive UI System

### Valtio State Management

The UI subscribes to Valtio state for reactive updates:

```typescript
// Component subscribes to runtime changes
const snap = useSnapshot(engineStore);
const _overrides = snap.runtime.overrides[nodeId]; // Triggers re-render on change
```

### Tick Order in AnimationEngine

```
┌─────────────────────────────────────────────────────────────┐
│  TICK SEQUENCE (every frame via GSAP ticker)                │
├─────────────────────────────────────────────────────────────┤
│  1. Update Master Time                                       │
│  2. computeNodes() - Generate fresh nodeOutputs              │
│  3. processConnections() - Propagate outputs to overrides    │
└─────────────────────────────────────────────────────────────┘
```

**Critical**: `computeNodes` MUST run before `processConnections` so connections read fresh output values, not stale ones from the previous frame.

### Connection Processing Flow

```typescript
// In processConnections():
if (isSourceEnabled) {
  // Source is ON: write output value to target's override
  overrides[targetNodeId][targetProp] = nodeOutputs[sourceNodeId][sourceProp];
} else {
  // Source is OFF: delete override (revert to baseProps)
  delete overrides[targetNodeId][targetProp];
}
```

---

## Node Registration System

### Creating New Nodes (2-File System)

New nodes require modifications to only **2 files**:

#### File 1: `src/core/nodeRegistrations.ts`

Register the node definition with compute function:

```typescript
registerNode({
  type: "CUSTOM_NODE",
  displayName: "Custom Node",
  category: "signal",
  defaultTimelineMode: "independent",

  inputs: [{ key: "inputValue", label: "Input", type: "number" }],
  outputs: [{ key: "value", label: "Output", type: "number" }],

  defaultProps: {
    myProp: 1.0,
    enabled: true,
    bypassed: false,
  },

  compute: (ctx: ComputeContext) => {
    const myProp = resolveProperty(ctx.nodeId, "myProp", 1.0);
    const result = myProp * ctx.time; // Example computation
    return { outputs: { value: result } };
  },
});
```

#### File 2: `src/ui/components/nodes/NodeContent.tsx`

Add visual content for the node:

```typescript
case NodeType.CUSTOM_NODE: {
  const resolvedValue = resolveProperty(node.id, 'myProp', 1.0);
  return (
    <div className="...">
      <Visualizer mode="static" frequency={resolvedValue} ... />
    </div>
  );
}
```

### Node Registry Architecture

```
┌─────────────────────────────────────────────────────────────┐
│  nodeRegistry.ts                                             │
│  └─ registerNode() - Store node definitions                  │
│  └─ getNodeDefinition() - Retrieve by type                   │
│  └─ getAllNodeDefinitions() - List all registered            │
├─────────────────────────────────────────────────────────────┤
│  nodeRegistrations.ts                                        │
│  └─ Calls registerNode() for each built-in node type         │
│  └─ SLIDER, NUMBER, BOOLEAN, OSCILLATOR, DEBUG, etc.         │
├─────────────────────────────────────────────────────────────┤
│  useNodeRegistration.ts                                      │
│  └─ React hook for runtime props sync                        │
│  └─ Syncs component props → store.baseProps                  │
└─────────────────────────────────────────────────────────────┘
```

---

## Static Oscillator Visualization

### Phase 1: External Override Animation Update

**Problem**: Oscillator animation didn't respond to connected values.

**Solution**: Use `resolveProperty()` instead of raw `node.config`:

```typescript
// Before (broken):
<Visualizer frequency={node.config.frequency} ... />

// After (working):
const resolvedFrequency = resolveProperty(node.id, 'frequency', 1);
<Visualizer frequency={resolvedFrequency} ... />
```

### Phase 2: Static Two-Box Display

**New Props** in `Visualizer.tsx`:

- `mode: 'animated' | 'static'`
- `waveform: WaveformType`

**Static Mode Renders**:

```
┌─────────────┬─────────────┐
│  [Wave SVG] │   [FREQ]    │
│             │    2.5      │
└─────────────┴─────────────┘
```

**New Tokens** in `waveform.ts`:

```typescript
// SVG paths for static waveform icons
export const waveformIconPaths: Record<WaveformType, string> = {
  sine: "M4,16 C12,4 20,4 24,16 S36,28 44,16",
  triangle: "M4,24 L16,8 L28,24 L40,8 L44,12",
  // ... etc
};

// Layout parameters
export const staticWaveformLayout = {
  iconBoxSize: 48,
  valueBoxMinWidth: 52,
  boxGap: 8,
  borderRadius: 8,
};
```

---

## Design System Tokens

### Token Categories

| File                 | Purpose                                           |
| -------------------- | ------------------------------------------------- |
| `colors.ts`          | All color values, surfaces, borders, text colors  |
| `waveform.ts`        | Waveform visualization colors, icon paths, layout |
| `layout.ts`          | Node dimensions, panel sizes, port positions      |
| `performance.ts`     | Quality tiers, throttling, LOD thresholds         |
| `shortcuts.ts`       | Keyboard shortcuts definitions                    |
| `spacing.ts`         | Spacing scale, semantic spacing                   |
| `animation.ts`       | Easing functions, durations                       |
| `nodeSizing.ts`      | Responsive node dimensions                        |
| `ports.ts`           | Port definitions, default inputs/outputs          |
| `engine.contract.ts` | Engine-UI communication interface                 |

### Usage Pattern

```typescript
// Import from barrel
import { getSurface, signalActive, staticWaveformLayout } from "@/tokens";

// Use token values
const bgColor = getSurface("panel", isDarkMode);
const activeColor = signalActive; // '#FF1F1F'
const iconSize = staticWaveformLayout.iconBoxSize;
```

### Adding New Tokens

1. Add to appropriate `src/ui/tokens/*.ts` file
2. Export from `src/ui/tokens/index.ts`
3. Import via `@/tokens` alias

---

## Troubleshooting Guide

### Issue: Values Don't Revert When Connection Disabled

**Symptoms**:

- LFO frequency stays at 50 even after SLIDER is disabled
- SidePanel shows connection value instead of base value

**Root Cause**: `baseProps` was being corrupted with override values.

**Solution Checklist**:

1. Check `AnimationEngine.processConnections()` clears overrides when source disabled
2. Verify no code writes to `baseProps` with override values
3. Ensure `updateNodeProps()` in store.ts filters overridden properties

### Issue: Values Inverted (ON shows base, OFF shows override)

**Symptoms**:

- SLIDER ON → LFO shows default value
- SLIDER OFF → LFO shows slider value

**Root Cause**: Tick order wrong - `processConnections` ran before `computeNodes`.

**Solution**: Ensure tick order is:

1. `computeNodes()` (generate outputs)
2. `processConnections()` (propagate to overrides)

### Issue: Values Don't Update Immediately After Connection

**Symptoms**:

- Must move slider after connecting for value to appear
- Toggle doesn't update until interaction

**Root Cause**: Component not subscribed to Valtio state changes.

**Solution**: Add `useSnapshot` subscription:

```typescript
const snap = useSnapshot(engineStore);
const _overrides = snap.runtime.overrides[nodeId]; // Triggers re-render
```

### Issue: SidePanel Overlaps Header

**Status**: Known issue, not yet addressed.

**Workaround**: Adjust initial Y position in SidePanel component.

---

## Not Yet Implemented (From Architecture Analysis)

These items were identified but not implemented in this session:

| Item                                | Description                                                         | Priority     |
| ----------------------------------- | ------------------------------------------------------------------- | ------------ |
| **Modifiers (D)**                   | Nodes that intercept and transform values between source and target | Future       |
| **Dirty Flagging**                  | Only recompute nodes whose inputs changed                           | Optimization |
| **Animation Curve Visual Feedback** | Editable bezier curve in node                                       | Future       |

---

## Session Continuation (December 23, 2024)

### UX Fixes Implemented

| Fix                             | Token/Change                                                                            |
| ------------------------------- | --------------------------------------------------------------------------------------- |
| **Drag Threshold**              | `interaction.dragThreshold: 8px` - pendingDrag pattern prevents accidental drags/copies |
| **Right-Click Box Select**      | `interaction.boxSelectMinSize: 10px` - visual rectangle with node intersection          |
| **Shortcuts Default Closed**    | `useState(false)` in ShortcutsPanel                                                     |
| **Undo Selection Preservation** | Removed selection clearing from undo/redo                                               |
| **SidePanel Position**          | `top-4` → `top-20` to avoid header                                                      |
| **Zoom Range**                  | `canvas.zoomMin: 0.1` (was 0.2) - 50% more zoom-out                                     |

### Phase 2 Planning

See [implementation_plan.md](file:///C:/Users/José%20Manuel/.gemini/antigravity/brain/6d6b0d1c-be31-44aa-82c1-7044ac2469f0/implementation_plan.md) for:

- Modifiers (value transformation)
- Dirty Flagging (compute optimization)
- SceneImporter node (Photoshop assets)
- Animation Viewport
- SVG Pattern node
- Web Workers / WebGPU evaluation

---

## Files Modified

### Core Architecture

- `src/engines/AnimationEngine.ts` - Tick order, processConnections logic
- `src/core/store.ts` - Override protection in updateNodeProps
- `src/core/resolveProperty.ts` - 3-level hierarchy resolution

### UI Components

- `src/ui/components/nodes/NodeContent.tsx` - resolveProperty usage, Valtio subscription
- `src/ui/components/nodes/Visualizer.tsx` - Static mode, waveform prop
- `src/ui/components/SidePanel.tsx` - Override protection in handleChange
- `src/ui/components/nodes/BaseNode.tsx` - Toggle button event propagation fixes

### Tokens

- `src/ui/tokens/waveform.ts` - Static waveform icons, layout tokens
- `src/ui/tokens/index.ts` - New exports

### Removed/Refactored

- `src/UIApp.tsx` - Removed legacy useEffect that corrupted baseProps

---

## Quick Reference

### Value Display Formula

```
displayValue = resolveProperty(nodeId, propKey, defaultValue)
             = overrides[propKey] ?? baseProps[propKey] ?? defaultValue
```

### Connection Data Flow

```
SourceNode.compute() → nodeOutputs[sourceId] → processConnections() →
overrides[targetId] → resolveProperty() → UI Display
```

### Enable/Disable Flow

```
SLIDER enabled=true  → processConnections writes override → LFO sees 50
SLIDER enabled=false → processConnections deletes override → LFO sees baseProps (1)
```
